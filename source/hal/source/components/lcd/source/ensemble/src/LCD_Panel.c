#include <stdint.h>
#include <stdio.h>
#include "Driver_PINMUX_AND_PINPAD.h"
#include "Driver_GPIO.h"
#include "mipi_dsi_host.h"
#include "RTE_Components.h"
#include "Driver_CDC200.h"
#include "image_processing.h"
#include "system_utils.h"
#include CMSIS_device_header

extern ARM_DRIVER_GPIO Driver_GPIO4;

int Display_reset(void)
{
	Driver_GPIO4.Initialize(PIN_NUMBER_6, NULL);
	Driver_GPIO4.PowerControl(PIN_NUMBER_6, ARM_POWER_FULL);
	Driver_GPIO4.SetValue(PIN_NUMBER_6, GPIO_PIN_OUTPUT_STATE_HIGH);
	Driver_GPIO4.SetDirection(PIN_NUMBER_6, GPIO_PIN_DIRECTION_OUTPUT);
	PINMUX_Config(PORT_NUMBER_4, PIN_NUMBER_6, PINMUX_ALTERNATE_FUNCTION_0);

	PMU_delay_loop_us(10000);

	Driver_GPIO4.SetValue(PIN_NUMBER_6, GPIO_PIN_OUTPUT_STATE_LOW);

	PMU_delay_loop_us(10000);

	Driver_GPIO4.SetValue(PIN_NUMBER_6, GPIO_PIN_OUTPUT_STATE_HIGH);

	PMU_delay_loop_us(100000);

	return ARM_DRIVER_OK;
}

int Display_BL_LED_EN(void)
{
	Driver_GPIO4.Initialize(PIN_NUMBER_4, NULL);
	Driver_GPIO4.PowerControl(PIN_NUMBER_4, ARM_POWER_FULL);
	Driver_GPIO4.SetValue(PIN_NUMBER_4, GPIO_PIN_OUTPUT_STATE_HIGH);
	Driver_GPIO4.SetDirection(PIN_NUMBER_4, GPIO_PIN_DIRECTION_OUTPUT);

	return ARM_DRIVER_OK;
}

void LCD_config ()
{
#if defined(E50RA_MW550_N)
	// E50RA-MW550-N
	// Change to Page 1 CMD
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x01);
	DCSW1_S(0x08,0x10);
	DCSW1_S(0x20,0x00);
	DCSW1_S(0x21,0x01);

	//Resolution setting
	//000 480X864
	//001 480X854
	//010 480X800
	//011 480X640
	//100 480X720
	DCSW1_S(0x30,0x01);
	DCSW1_S(0x31,0x00);

	DCSW1_S(0x40,0x16);
	DCSW1_S(0x41,0x33);
	DCSW1_S(0x42,0x03);
	DCSW1_S(0x43,0x09);
	DCSW1_S(0x44,0x06);

	DCSW1_S(0x50,0x88);
	DCSW1_S(0x51,0x88);
	DCSW1_S(0x52,0x00);
	DCSW1_S(0x53,0x49);
	DCSW1_S(0x55,0x49);

	DCSW1_S(0x60,0x07);
	DCSW1_S(0x61,0x00);
	DCSW1_S(0x62,0x07);
	DCSW1_S(0x63,0x00);

	DCSW1_S(0xA0,0x00);
	DCSW1_S(0xA1,0x09);
	DCSW1_S(0xA2,0x11);
	DCSW1_S(0xA3,0x0B);
	DCSW1_S(0xA4,0x05);
	DCSW1_S(0xA5,0x08);
	DCSW1_S(0xA6,0x06);
	DCSW1_S(0xA7,0x04);
	DCSW1_S(0xA8,0x09);
	DCSW1_S(0xA9,0x0C);
	DCSW1_S(0xAA,0x15);
	DCSW1_S(0xAB,0x08);
	DCSW1_S(0xAC,0x0F);
	DCSW1_S(0xAD,0x12);
	DCSW1_S(0xAE,0x09);
	DCSW1_S(0xAF,0x00);

	DCSW1_S(0xC0,0x00);
	DCSW1_S(0xC1,0x09);
	DCSW1_S(0xC2,0x10);
	DCSW1_S(0xC3,0x0C);
	DCSW1_S(0xC4,0x05);
	DCSW1_S(0xC5,0x08);
	DCSW1_S(0xC6,0x06);
	DCSW1_S(0xC7,0x04);
	DCSW1_S(0xC8,0x08);
	DCSW1_S(0xC9,0x0C);
	DCSW1_S(0xCA,0x14);
	DCSW1_S(0xCB,0x08);
	DCSW1_S(0xCC,0x0F);
	DCSW1_S(0xCD,0x11);
	DCSW1_S(0xCE,0x09);
	DCSW1_S(0xCF,0x00);

	// Change to Page 6 CMD for GIP timing
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x06);

	DCSW1_S(0x00,0x20);
	DCSW1_S(0x01,0x0A);
	DCSW1_S(0x02,0x00);
	DCSW1_S(0x03,0x00);
	DCSW1_S(0x04,0x01);
	DCSW1_S(0x05,0x01);
	DCSW1_S(0x06,0x98);
	DCSW1_S(0x07,0x06);
	DCSW1_S(0x08,0x01);
	DCSW1_S(0x09,0x80);
	DCSW1_S(0x0A,0x00);
	DCSW1_S(0x0B,0x00);
	DCSW1_S(0x0C,0x01);
	DCSW1_S(0x0D,0x01);
	DCSW1_S(0x0E,0x05);
	DCSW1_S(0x0F,0x00);

	DCSW1_S(0x10,0xF0);
	DCSW1_S(0x11,0xF4);
	DCSW1_S(0x12,0x01);
	DCSW1_S(0x13,0x00);
	DCSW1_S(0x14,0x00);
	DCSW1_S(0x15,0xC0);
	DCSW1_S(0x16,0x08);
	DCSW1_S(0x17,0x00);
	DCSW1_S(0x18,0x00);
	DCSW1_S(0x19,0x00);
	DCSW1_S(0x1A,0x00);
	DCSW1_S(0x1B,0x00);
	DCSW1_S(0x1C,0x00);
	DCSW1_S(0x1D,0x00);

	DCSW1_S(0x20,0x01);
	DCSW1_S(0x21,0x23);
	DCSW1_S(0x22,0x45);
	DCSW1_S(0x23,0x67);
	DCSW1_S(0x24,0x01);
	DCSW1_S(0x25,0x23);
	DCSW1_S(0x26,0x45);
	DCSW1_S(0x27,0x67);

	DCSW1_S(0x30,0x11);
	DCSW1_S(0x31,0x11);
	DCSW1_S(0x32,0x00);
	DCSW1_S(0x33,0xEE);
	DCSW1_S(0x34,0xFF);
	DCSW1_S(0x35,0xBB);
	DCSW1_S(0x36,0xAA);
	DCSW1_S(0x37,0xDD);
	DCSW1_S(0x38,0xCC);
	DCSW1_S(0x39,0x66);
	DCSW1_S(0x3A,0x77);
	DCSW1_S(0x3B,0x22);
	DCSW1_S(0x3C,0x22);
	DCSW1_S(0x3D,0x22);
	DCSW1_S(0x3E,0x22);
	DCSW1_S(0x3F,0x22);
	DCSW1_S(0x40,0x22);

	// Change to Page 7 CMD for GIP timing
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x07);
	DCSW1_S(0x17,0x22);
	DCSW1_S(0x02,0x77);
	DCSW1_S(0x26,0xB2);

	// Change to Page 0 CMD for Normal command
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x00);
	DCSWN_S(0x35);
	DCSW1_S(0x3A,0x70);

#elif defined(E43RB_FW405_C)
	// E43RB-FW405-C
	// Change to Page 1 CMD
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x01);
	DCSW1_S(0x08,0x00);

	DCSW1_S(0x20,0x00);
	DCSW1_S(0x21,0x01);

	//Resolution setting
	//0x00 480X864
	//0x01 480X854
	//0x02 480X800
	//0x03 480X640
	//0x04 480X720
	DCSW1_S(0x30,0x02);
	DCSW1_S(0x31,0x00);

	DCSW1_S(0x40,0x00);
	DCSW1_S(0x41,0x33);
	DCSW1_S(0x42,0x02);
	DCSW1_S(0x43,0x89);
	DCSW1_S(0x44,0x89);
	DCSW1_S(0x46,0x34);

	DCSW1_S(0x50,0xA8);
	DCSW1_S(0x51,0xA8);
	DCSW1_S(0x52,0x00);
	DCSW1_S(0x53,0x78);
	DCSW1_S(0x54,0x00);
	DCSW1_S(0x55,0x78);

	DCSW1_S(0x60,0x07);
	DCSW1_S(0x61,0x04);
	DCSW1_S(0x62,0x08);
	DCSW1_S(0x63,0x04);

	DCSW1_S(0xA0,0x00);
	DCSW1_S(0xA1,0x0B);
	DCSW1_S(0xA2,0x13);
	DCSW1_S(0xA3,0x0D);
	DCSW1_S(0xA4,0x07);
	DCSW1_S(0xA5,0x0B);
	DCSW1_S(0xA6,0x07);
	DCSW1_S(0xA7,0x06);
	DCSW1_S(0xA8,0x07);
	DCSW1_S(0xA9,0x0A);
	DCSW1_S(0xAA,0x12);
	DCSW1_S(0xAB,0x0D);
	DCSW1_S(0xAC,0x11);
	DCSW1_S(0xAD,0x0F);
	DCSW1_S(0xAE,0x0E);
	DCSW1_S(0xAF,0x0B);

	DCSW1_S(0xC0,0x00);
	DCSW1_S(0xC1,0x0B);
	DCSW1_S(0xC2,0x13);
	DCSW1_S(0xC3,0x0D);
	DCSW1_S(0xC4,0x06);
	DCSW1_S(0xC5,0x0B);
	DCSW1_S(0xC6,0x07);
	DCSW1_S(0xC7,0x06);
	DCSW1_S(0xC8,0x07);
	DCSW1_S(0xC9,0x0A);
	DCSW1_S(0xCA,0x12);
	DCSW1_S(0xCB,0x0D);
	DCSW1_S(0xCC,0x11);
	DCSW1_S(0xCD,0x0F);
	DCSW1_S(0xCE,0x0E);
	DCSW1_S(0xCF,0x0B);

	// Change to Page 6 CMD for GIP timing
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x06);

	DCSW1_S(0x00,0x21);
	DCSW1_S(0x01,0x09);
	DCSW1_S(0x02,0x00);
	DCSW1_S(0x03,0x00);
	DCSW1_S(0x04,0x01);
	DCSW1_S(0x05,0x01);
	DCSW1_S(0x06,0x98);
	DCSW1_S(0x07,0x06);
	DCSW1_S(0x08,0x02);
	DCSW1_S(0x09,0x00);
	DCSW1_S(0x0A,0x00);
	DCSW1_S(0x0B,0x00);
	DCSW1_S(0x0C,0x01);
	DCSW1_S(0x0D,0x01);
	DCSW1_S(0x0E,0x00);
	DCSW1_S(0x0F,0x00);

	DCSW1_S(0x10,0xE0);
	DCSW1_S(0x11,0xE0);
	DCSW1_S(0x12,0x00);
	DCSW1_S(0x13,0x00);
	DCSW1_S(0x14,0x00);
	DCSW1_S(0x15,0x43);
	DCSW1_S(0x16,0x0B);
	DCSW1_S(0x17,0x00);
	DCSW1_S(0x18,0x00);
	DCSW1_S(0x19,0x00);
	DCSW1_S(0x1A,0x00);
	DCSW1_S(0x1B,0x00);
	DCSW1_S(0x1C,0x00);
	DCSW1_S(0x1D,0x00);

	DCSW1_S(0x20,0x01);
	DCSW1_S(0x21,0x23);
	DCSW1_S(0x22,0x45);
	DCSW1_S(0x23,0x67);
	DCSW1_S(0x24,0x01);
	DCSW1_S(0x25,0x23);
	DCSW1_S(0x26,0x45);
	DCSW1_S(0x27,0x67);

	DCSW1_S(0x30,0x01);
	DCSW1_S(0x31,0x11);
	DCSW1_S(0x32,0x00);
	DCSW1_S(0x33,0x22);
	DCSW1_S(0x34,0x22);
	DCSW1_S(0x35,0xCB);
	DCSW1_S(0x36,0xDA);
	DCSW1_S(0x37,0xAD);
	DCSW1_S(0x38,0xBC);
	DCSW1_S(0x39,0x66);
	DCSW1_S(0x3A,0x77);
	DCSW1_S(0x3B,0x22);
	DCSW1_S(0x3C,0x22);
	DCSW1_S(0x3D,0x22);
	DCSW1_S(0x3E,0x22);
	DCSW1_S(0x3F,0x22);
	DCSW1_S(0x40,0x22);

	// Change to Page 7 CMD for GIP timing
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x07);
	DCSW1_S(0x18,0x1D);
	DCSW1_S(0x02,0x77);
	DCSW1_S(0xE1,0x79);

	// Change to Page 0 CMD for Normal command
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x00);
	DCSW1_S(0x36,0x01);
	DCSW1_S(0x3A,0x70);

#elif defined(E43GB_MW405_C)
	// Change to Page 1 CMD
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x01);
	DCSW1_S(0x08,0x10);

	DCSW1_S(0x20,0x00);
	DCSW1_S(0x21,0x01);

	//Resolution setting
	//0x00 480X864
	//0x01 480X854
	//0x02 480X800
	//0x03 480X640
	//0x04 480X720
	DCSW1_S(0x30,0x01);
	DCSW1_S(0x31,0x00);

	DCSW1_S(0x40,0x14);
	DCSW1_S(0x41,0x22);
	DCSW1_S(0x42,0x02);
	DCSW1_S(0x43,0x84);
	DCSW1_S(0x44,0x8A);

	DCSW1_S(0x50,0x78);
	DCSW1_S(0x51,0x78);
	DCSW1_S(0x52,0x00);
	DCSW1_S(0x53,0x2B);
	DCSW1_S(0x54,0x00);
	DCSW1_S(0x55,0x2B);

	DCSW1_S(0x60,0x07);
	DCSW1_S(0x61,0x06);
	DCSW1_S(0x62,0x06);
	DCSW1_S(0x63,0x04);

	DCSW1_S(0xA0,0x00);
	DCSW1_S(0xA1,0x0B);
	DCSW1_S(0xA2,0x19);
	DCSW1_S(0xA3,0x10);
	DCSW1_S(0xA4,0x06);
	DCSW1_S(0xA5,0x0F);
	DCSW1_S(0xA6,0x09);
	DCSW1_S(0xA7,0x06);
	DCSW1_S(0xA8,0x0C);
	DCSW1_S(0xA9,0x0E);
	DCSW1_S(0xAA,0x16);
	DCSW1_S(0xAB,0x0D);
	DCSW1_S(0xAC,0x15);
	DCSW1_S(0xAD,0x0F);
	DCSW1_S(0xAE,0x11);
	DCSW1_S(0xAF,0x00);

	DCSW1_S(0xC0,0x00);
	DCSW1_S(0xC1,0x24);
	DCSW1_S(0xC2,0x29);
	DCSW1_S(0xC3,0x0C);
	DCSW1_S(0xC4,0x07);
	DCSW1_S(0xC5,0x03);
	DCSW1_S(0xC6,0x03);
	DCSW1_S(0xC7,0x03);
	DCSW1_S(0xC8,0x03);
	DCSW1_S(0xC9,0x09);
	DCSW1_S(0xCA,0x0D);
	DCSW1_S(0xCB,0x01);
	DCSW1_S(0xCC,0x06);
	DCSW1_S(0xCD,0x1B);
	DCSW1_S(0xCE,0x08);
	DCSW1_S(0xCF,0x00);

	// Change to Page 6 CMD for GIP timing
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x06);

	DCSW1_S(0x00,0x20);
	DCSW1_S(0x01,0x04);
	DCSW1_S(0x02,0x00);
	DCSW1_S(0x03,0x00);
	DCSW1_S(0x04,0x01);
	DCSW1_S(0x05,0x01);
	DCSW1_S(0x06,0x88);
	DCSW1_S(0x07,0x04);
	DCSW1_S(0x08,0x01);
	DCSW1_S(0x09,0x90);
	DCSW1_S(0x0A,0x03);
	DCSW1_S(0x0B,0x01);
	DCSW1_S(0x0C,0x01);
	DCSW1_S(0x0D,0x01);
	DCSW1_S(0x0E,0x00);
	DCSW1_S(0x0F,0x00);

	DCSW1_S(0x10,0x55);
	DCSW1_S(0x11,0x53);
	DCSW1_S(0x12,0x01);
	DCSW1_S(0x13,0x0D);
	DCSW1_S(0x14,0x0D);
	DCSW1_S(0x15,0x43);
	DCSW1_S(0x16,0x0B);
	DCSW1_S(0x17,0x00);
	DCSW1_S(0x18,0x00);
	DCSW1_S(0x19,0x00);
	DCSW1_S(0x1A,0x00);
	DCSW1_S(0x1B,0x00);
	DCSW1_S(0x1C,0x00);
	DCSW1_S(0x1D,0x00);

	DCSW1_S(0x20,0x01);
	DCSW1_S(0x21,0x23);
	DCSW1_S(0x22,0x45);
	DCSW1_S(0x23,0x67);
	DCSW1_S(0x24,0x01);
	DCSW1_S(0x25,0x23);
	DCSW1_S(0x26,0x45);
	DCSW1_S(0x27,0x67);

	DCSW1_S(0x30,0x02);
	DCSW1_S(0x31,0x22);
	DCSW1_S(0x32,0x11);
	DCSW1_S(0x33,0xAA);
	DCSW1_S(0x34,0xBB);
	DCSW1_S(0x35,0x66);
	DCSW1_S(0x36,0x00);
	DCSW1_S(0x37,0x22);
	DCSW1_S(0x38,0x22);
	DCSW1_S(0x39,0x22);
	DCSW1_S(0x3A,0x22);
	DCSW1_S(0x3B,0x22);
	DCSW1_S(0x3C,0x22);
	DCSW1_S(0x3D,0x22);
	DCSW1_S(0x3E,0x22);
	DCSW1_S(0x3F,0x22);
	DCSW1_S(0x40,0x22);

	// Change to Page 5 CMD
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x05);
	DCSW1_S(0x09,0xFC);
	DCSW1_S(0x07,0xBC);

	// Change to Page 0 CMD for Normal command
	DCSW_L(0xFF, 0x98, 0x06, 0x04, 0x00);
	DCSW1_S(0x3A,0x70);
#else
#error
#endif

	//sleep exit
	DCSWN_S(0x11);
	PMU_delay_loop_us(120000);

	DCSWN_S(0x29);
	PMU_delay_loop_us(25000);

	//05 DCS Write, No Parameter SPa (Short Packet) DCSWN-S
	//Normal Display mode on
	DCSW1_S(0x05, 0x13);

	//05 DCS Write, No Parameter SPa (Short Packet) DCSWN-S
	//All Pixel On
	DCSW1_S(0x05, 0x23);

	//05 DCS Write, No Parameter SPa (Short Packet) DCSWN-S
	//Display On
	DCSW1_S(0x05, 0x29);
}

const static display_panel cdc = {

	.height = VACT,
	.width = HACT,
	.hsync = HSA,
	.vsync = VSA,
	.h_back_porch = HBP,
	.v_back_porch = VBP,
	.h_front_porch = HFP,
	.v_front_porch = VFP,
};

int Display_initialization(uint8_t *buffer)
{
	////////////////////////////////////////////////////////////////////////////
	// MIPI DPI Controller Setup (CDC200)
	////////////////////////////////////////////////////////////////////////////

	display_controller_setup((uint32_t)(buffer), RGB888, &cdc);

	////////////////////////////////////////////////////////////////
	// MIPI D-PHY SETUP
	////////////////////////////////////////////////////////////////

	tx_phyconfig();

	dsi_command_mode_initialization();

	Display_reset();

	LCD_config();

	dsi_video_mode_initialization();

	display_controller_enable(1);

	Display_BL_LED_EN();

	return 0;
}
